Stmycluster1=parcluster('local');
Stmycluster1.NumWorkers=60;
parpool(Stmycluster1,60,'SpmdEnabled',false);



nproc = 60;

vf = [0.00100000000000000	0.00150000000000000	0.00200000000000000	0.00250000000000000	0.00255000000000000	0.00260000000000000	0.00265000000000000	0.00270000000000000	0.00275000000000000	0.00280000000000000	0.00285000000000000	0.00290000000000000	0.00291000000000000	0.00292000000000000	0.00293000000000000	0.00294000000000000	0.00295000000000000	0.00296000000000000	0.00297000000000000	0.00298000000000000	0.00299000000000000	0.00300000000000000	0.00301000000000000	0.00302000000000000	0.00303000000000000	0.00304000000000000	0.00305000000000000	0.00306000000000000	0.00307000000000000	0.00308000000000000	0.00309000000000000	0.00310000000000000	0.00311000000000000	0.00312000000000000	0.00313000000000000	0.00314000000000000	0.00315000000000000	0.00316000000000000	0.00317000000000000	0.00318000000000000	0.00319000000000000	0.00320000000000000	0.00321000000000000	0.00322000000000000	0.00323000000000000	0.00324000000000000	0.00325000000000000	0.00326000000000000	0.00327000000000000	0.00328000000000000	0.00329000000000000	0.00330000000000000	0.00331000000000000	0.00332000000000000	0.00333000000000000	0.00334000000000000	0.00335000000000000	0.00336000000000000	0.00337000000000000	0.00338000000000000	0.00339000000000000	0.00340000000000000	0.00341000000000000	0.00342000000000000	0.00343000000000000	0.00344000000000000	0.00345000000000000	0.00346000000000000	0.00347000000000000	0.00348000000000000	0.00349000000000000	0.00350000000000000	0.00351000000000000	0.00352000000000000	0.00353000000000000	0.00354000000000000	0.00355000000000000	0.00356000000000000	0.00357000000000000	0.00358000000000000	0.00359000000000000	0.00360000000000000	0.00361000000000000	0.00362000000000000	0.00363000000000000	0.00364000000000000	0.00365000000000000	0.00366000000000000	0.00367000000000000	0.00368000000000000	0.00369000000000000	0.00370000000000000	0.00371000000000000	0.00372000000000000	0.00373000000000000	0.00374000000000000	0.00375000000000000	0.00376000000000000	0.00377000000000000	0.00378000000000000	0.00379000000000000	0.00380000000000000	0.00381000000000000	0.00382000000000000	0.00383000000000000	0.00384000000000000	0.00385000000000000	0.00386000000000000	0.00387000000000000	0.00388000000000000	0.00389000000000000	0.00390000000000000	0.00391000000000000	0.00392000000000000	0.00393000000000000	0.00394000000000000	0.00395000000000000	0.00396000000000000	0.00397000000000000	0.00398000000000000	0.00399000000000000	0.00400000000000000	0.00450000000000000	0.00500000000000000	0.00550000000000000	0.00600000000000000	0.00700000000000000  0.008];
parfor ii = 1:nproc
    Total1 = [];
    Total2 = [];
    Total2bis = [];
    Total21 = [];
    
    [dCNT, ja,~, ~, ~, ~, Ptrue1, ~, Length1, ~, RVE] = poursave_postprocess_CNT_new(sprintf('CNT_Cond_Vf0-8p_L1000n_c_2n_li100n_D1n_N60_%d.mat', ii));
    %[dCNT, ja, Ptrue1, Length1, RVE]=poursave_postprocess_CNT(sprintf('CNT_Cond_Vf0-8p_L1000n_c_2n_li100n_D1n_N60_%d.mat', ii));
    cum = 0.25*(pi*RVE.D^2)*cumsum(Length1)/(RVE.size(1)^3);
    P = zeros(1,length(vf));
    for j=1:length(vf)
        Gtotal2 = 0; %In case of no percolation
        flag2 = 0;
        a = find(cum>=vf(j));
        
        [Nj, Njbis, Nj1, Gn, perco ] = A_ResNetwork_Soft_leafs_notouch_Nj_Nj1(dCNT(1:a(1),1:a(1)), ja(1:a(1),1:a(1)), Ptrue1(1:2*a(1),:), RVE); %find the network resistance matrix
        P(j) = perco; %percolation value (1 or 0)
        
        if perco ==0
            %disp('// Warning: No percolation cluster exist!');
        else
            bn = zeros(length(Gn),1);
            bn(length(Gn))= 1;
            setup = [];
            setup.droptol = 1e-15;                       %tolerance
            maxit = 3e6;
            setup.type = 'ict';
            
            L1=ichol(Gn,setup);
            [xn1,flag1]=pcg(Gn,bn,1e-4,maxit,L1,L1');
            [xn,flag2]=pcg(Gn,bn,1e-4,maxit,L1,L1',xn1);
            Res2 = xn(length(Gn));
            %disp(['// Resistance2 = ',num2str(Res2),' Ohm']);
            
            Gtotal2=(RVE.size(3)*10^-6)/(Res2*RVE.size(1)*RVE.size(2)*10^-12);
            %disp(['// Conductivity = ',num2str(Gtotal2),' S/m'])
        end
        Total1 = [Total1 Gtotal2];
        Total2 = [Total2 Nj];
        Total2bis = [Total2bis Njbis];
        Total21 = [Total21 Nj1];
        
        
    end
    COND(ii,:) = Total1;
    Numb(ii,:) = Total2;
    Numb_bis(ii,:) = Total2bis;
    Numb1(ii,:) = Total21;
    Perco(ii,:) = P;
end

for i = 1:length(vf)
    p(i) = length(find(Perco(:,i)))/nproc; %probability of percolation
    C(i) = mean(COND(:,i));%mean of conductivity
    Nj(i) = mean(Numb(:,i));%mean of number of junction
    Njbis(i) = mean(Numb_bis(:,i));%mean of number of junction
    Nj1(i) = mean(Numb1(:,i));%mean of number of junction
end

Result = [vf;p;C;Nj;Njbis;Nj1];
save('CNT_Cond_Vf0-8p_L1000n_c_2n_li100n_D1n_bis.mat','Result');
%plot(vf,p)
delete(gcp('nocreate'))